---
title: "ETHOS Analysis"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    keep_tex: yes
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

#### Packages

Load the packages required for the analysis. If packages haven't been installed yet, use ```install.packages()``` followed by the ```library()``` function. 

Another way to load packages is through the pacman package using the ```p_load()``` function. 


```{r echo=FALSE, include=FALSE}
pacman::p_load(
  ggplot2 ,    # plotting and graphing results
   rlang,      # read in excel files
   forcats,    # read in excel files
   broom,      # tidy code
   readxl,     # read in excel files
   pacman,     # loading and reading in packages
   rio,        # importing data  
   here,       # relative file pathways  
   janitor,    # data cleaning and tables
   lubridate,  # working with dates
   matchmaker, # dictionary-based cleaning
   epikit,     # age_categories() function
   tidyverse,  # data management and visualization
   gtsummary,  # logistic regression and plotting results
   gt,         # for gtsummary 
   flextable,  # table creation and manipulating
   car,        # data management and visualization
   readstata13,# read in Stata files
   finalfit,   # logistic regression and plotting results
   survminer,  # forest plots
   easystats, 
   BiocManager, 
   survival, 
   forestplot, 
   rticles,     # templates for scientific journal articles in RMarkdown
   jtools, 
   corrplot, 
   bstfun, 
   ggforestplot, 
   codebookr,
   codebook,
   sjlabelled, 
   likert, 
   kableExtra, 
   haven
)

```

### DATA MANAGEMENT
***

<!-- ## Chunk Settings -->

<!-- ```{r setup, include = FALSE} -->
<!-- knitr::opts_chunk$set( -->
<!--   echo = FALSE, -->
<!--   warning = FALSE, -->
<!--   message = FALSE -->
<!--   ) -->
<!-- ``` -->


Set working directory

```{r}
setwd("C:/Users/mjstowe/OneDrive - UNSW/Desktop/R")
```

Read in the dataset as a .csv file


```{r}
ethos <- read.csv("ethos.engage.csv")

```

```{r}
ethos<- read_dta("enrollment survey POC merged_final.dta") 
```


Explore the dataset

<!-- # ```{r} -->
<!-- # skimr::skim(ethos) -->
<!-- # ``` -->

### DATA CLEANING
***
```{r}
ethos <- ethos %>% 
  janitor::clean_names()
```

If we wanted to create a new column that seperated out the waves based on a particular date/time - use the code below.

ETHOS Engage is an observational cohort study. Participants were enrolled across two recruitment waves. During Wave 1 (May 2018- September 2019) recruitment occurred in 25 sites, including drug treat- ment clinics (n = 21) and needle and syringe programs (NSPs) (n = 4). Dur- ing Wave 2 (November 2019-June 2021), participants were recruited from 21 of the 25 sites which participated in Wave 1, including drug treatment clinics (n = 19) and NSPs (n = 2) (Supplementary Table 1). Individuals who were enrolled within and between Wave 1 and Wave 2 were identified by two-by-two name code (first two letters of first name and last name) and date of birth.

Enhancing Treatment of Hepatitis C in Opioid Substitution Settings (ETHOS) Engage is a national observational cohort study of people who have a history of injecting drug use, and report injecting drug use in the preceding six months or are currently receiving OAT (comprising methadone, buprenorphine, and buprenorphine-naloxone in Australia). The study procedures have been described elsewhere ( Valerio et al., 2020 ). Participants were enrolled between 28 May 2018 and 06 Septem- ber 2019. Convenience sampling was employed at 25 sites, including drug treatment clinics (n = 21) and needle syringe programs ( n = 4), in New South Wales ( n = 17), Queensland (n = 4), South Australia (n = 2) and Western Australia ( n = 2).

***
## **Outcomes**

The primary outcome was preference for opioid agonist treatment. Frequencies and percentages of preferred OAT were generated based on the question “Of all the following types of medications available in Australia for the management of opioid use disorder, if you could choose today, which would be your first choice?” Options included methadone, buprenorphine (taken orally as a film or pill), long acting injectable buprenorphine, any treatment (no preference), and no treatment. Frequencies and percentages were generated from responses. 
Demographic, behavioural, and clinical factors hypothesised to be associated with preference to receive OAT treatment were determined a priori, comprising the following: 1) age at survey (18 - 29; 30 – 39; 40 – 49; > 50 years old) ), 2) gender (female; male; transgender), 3) education (< year 10; > year 10), 4) employment (formal; informal), 5) homelessness (yes; no), 6) incarceration history (never, >1 year ago, within the last year), 7) recency and frequency of injection drug use (>1 year ago, within 1–12 months ago, within the last month less than daily, and daily or more), 8) drugs injected in the last month (none, heroin, other opioids, methamphetamine, other), 9) previous OAT (yes; no), 10) previous OAT with methadone (yes; no); and 11) previous OAT with buprenorphine (yes; no). Among those currently receiving OAT, factors included 1) current OAT medication (methadone; buprenorphine; buprenorphine-naloxone; long acting depot buprenorphine; none) and current dosages (mg). 


<!-- ```{r} -->
<!-- ethos. <- ethos[complete.cases(ethos), ] # This deletes all rows with missing values -->
<!-- ``` -->

<!-- ```{r} -->
<!-- <!-- knitr::kable(head(ethos)) -->
<!-- ``` -->

#### Waves

```{r}
ethos %<>% 
  mutate(waves = case_when(
    wave2 == 0 ~ "Wave 1",
    wave2 == 1 ~ "Wave 2"
  ))
```

#### Age group

```{r}
ethos <- ethos %>% 
  mutate(age.group = case_when(
    surveyage > 18 & surveyage < 30    ~ "< 29 ",
    surveyage >= 30 &  surveyage < 40  ~ "30 - 39",
    surveyage >= 40 &  surveyage < 50  ~ "40 - 49",
    surveyage >= 50             ~ "> 50",
    is.na(NA)                     ~ NA_character_,
    TRUE                  ~ "Check me"))
```

<!-- ```{r} -->
<!-- ggplot() + geom_boxplot(data = ethos, mapping = aes(x=age, fill = prefer.metbup)) + -->
<!--   theme_bw()+theme_void -->
<!-- ``` -->

<!-- ```{r} -->
<!-- print(ag) -->

#### Age 

```{r}
age <- as.numeric(ethos$surveyage)

ethos <- ethos %>%
  mutate(age = age)

```

<!-- ```{r} -->
<!-- ggplot()+ -->
<!--   geom_histogram(data = ethos, mapping = aes(x=age, fill = waves), color = "black", bins = 30)+ -->
<!--   geom_vline(xintercept=mean(ethos$age), color='red')+labs(x="Age", y="Count",title ="Distribution plot of Age")+theme_bw() -->
<!-- ``` -->

```{r}

tbl.a <- ethos %>% 
  gtsummary::tbl_summary(
     by = stigma.inject.yn,
    include = c(homeless.fct,
                     prison.yn, inject.month,
                     inject.year, injectdrug.month,
                     injectfreq.month, injectdays.month, 
                     oat.ever.yn,  
                     oat.type,
                     methadone.dose,
                     laib.dose.wk, 
                     laib.dose.month,
                     dose.satisfied, 
                     dose.location, 
                     dose.takeaways.yn,
                     stigma.inject.yn, 
                     discrim.yn, prefer.metbup),
    statistic = list(all_categorical() ~ "{n} ({p}%)")
  ) %>%
  gtsummary::bold_labels() %>%   
  gtsummary::modify_header(
    label = "**Characteristic**", 
    all_stat_cols() ~ "**{level}**\nN = {n}"
  ) %>%
  gtsummary::as_kable_extra(
    format = "latex",
    booktabs = TRUE,
    longtable = TRUE,
    linesep = ""
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header"),
      stripe_color = "gray!15")
    
```


```{r}
tbl.a
```

#### Homeless

```{r}
ethos <- ethos %>% 
  mutate(homeless.fct= case_when(
    homeless == 0 ~ "No",
    homeless == 1 ~ "Yes"
        ))
```

#### Ethnicity
   
```{r}
 ethos <- ethos %>%
   mutate(atsi = case_when(
     eatsi == 0              ~ "Non-indigenous",
     eatsi == 1              ~ "Aboriginal",
     eatsi == 2              ~ "Torres Strait Islander",
     eatsi == 3              ~ "Both Aboriginal and Torres Strait Islander",
     eatsi == 99              ~ "Unknown"))

```

Reorder the ethnicity variable

```{r}
 ethos <- ethos %>%
   mutate(atsi = fct_relevel(atsi,
                            "Non-indigenous",
                            "Aboriginal",
                            "Torres Strait Islander",
                            "Both Aboriginal and Torres Strait Islander",
                            "Unknown"
                            ))
```

Collapsing ethnicity categories into non-indigienous and aboriginal

```{r}
 atsi_collapse <- fct_collapse(ethos$atsi, Aboriginal = c("Torres Strait Islander", "Both Aboriginal and Torres Strait Islander"))
```

Add to the dataset

```{r}
 atsi <- ethos %>%
   mutate(atsi_collapse=(atsi_collapse))
```

#### Incarceration 

4. Have you ever been in prison or a juvenile justice centre?

```{r}
ethos <- ethos %>% 
  mutate(prison.yn = case_when(
    sapjjce == 1              ~ "Yes",
    sapjjce == 0              ~ "No"

    ))
```

5. Have you ever been in prison or a juvenile justice centre in the last 6 months?

```{r}
ethos <- ethos %>% 
  mutate(prison.6month = case_when(
    sapjjcl6m == 0              ~ "No",
    sapjjcl6m == 1              ~ "Yes"
  ))
```

## SECTION B: INJECTING DRUG USE AND ALCOHOL

6. Have you injected drugs in the last month? 

```{r}
ethos <- ethos %>% 
  mutate(inject.month = case_when(
    sbinj1m  == 0              ~ "No",
    sbinj1m == 1              ~ "Yes"
  ))

```

7. Have you injected drugs in the last month? 

```{r}
ethos <- ethos %>% 
  mutate(inject.6month = case_when(
    sbinj6m  == 0              ~ "No",
    sbinj6m == 1              ~ "Yes"
  ))
```


8. Have you injected drugs in the year? 
```{r}
ethos <- ethos %>% 
  mutate(inject.year = case_when(
    sbinj1y  == 0              ~ "No",
    sbinj1y == 1              ~ "Yes"
  ))
```

9. What drug did you inject most often in the last month?Injecting - drug specific
```{r}
ethos <- ethos %>% 
  mutate(injectdrug.month = case_when(
    sbinjdrg  == 1      ~ "Heroin",
    sbinjdrg  == 2      ~ "Cocaine",
    sbinjdrg  == 3      ~ "Amphetamines", 
    sbinjdrg  == 4      ~ "Other opioids", 
    sbinjdrg  == 5      ~ "Benzodiazepines", 
    sbinjdrg  == 77     ~ "Other"))

# Reordering the levels of the drug specific injecting attributes

ethos <- ethos %>% 
  mutate(injectdrug.month = fct_relevel(injectdrug.month,
                                     "Heroin",
                                     "Other opioids",
                                     "Amphetamines",
                                     "Cocaine",
                                     "Benzodiazepines", 
                                     "Other"))
```

10. How often did you inject drugs in the last month?

```{r}
ethos <- ethos %>% 
  mutate(injectfreq.month = case_when(
    sbidl1m == 1              ~ "More than 3 times a day",
    sbidl1m == 5              ~ "Weekly or less",
    sbidl1m == 4              ~ "More than weekly, not daily",
    sbidl1m == 3              ~ "Once daily",
    sbidl1m == 2              ~ "2 - 3 times a day"
  ))
```

Reordering the level of the injecting frequency attributes

```{r}
ethos <- ethos %>% 
  mutate(injectfreq.month = fct_relevel(injectfreq.month,
                                     "Once daily", 
                                     "2 - 3 times a day",
                                     "More than 3 times a day",
                                     "Weekly or less",
                                     "More than weekly, not daily"
  ))
```

11. How many days have you injected drugs in the last month?
```{r}
injectdays.month <- as.numeric(ethos$sbdaysinj)

ethos <- ethos %>% 
mutate(injectdays.month = as.numeric(injectdays.month))
```

## SECTION D: DRUG TREATMENT

55. Of all the following medications used to treat OUD, which would you prefer? 

```{r}
ethos <- ethos %>% 
  mutate(oat.prefer = case_when(
    sdoppr == 1              ~ "Methadone",
    sdoppr == 2              ~ "Buprenorphine (Subutex)",
    sdoppr == 3              ~ "Buprenorphine (Any formulation)",
    sdoppr == 4              ~ "Buprenorphine (long acting injectable)",
    sdoppr == 5              ~ "Buprenorphine-naloxone (Suboxone)",
    sdoppr == 6              ~ "Any - no preference",
    sdoppr == 7              ~ "None - no medication or treatment",
    sdoppr == 8              ~ "None - no appropriate medication",
    sdoppr == 9              ~ "None - not interested in treatment"))
```


Create a new variable "prefer.treat.yn" that describe if participants would prefer treatment [yes/no]

```{r}
ethos <- ethos %>% 
  mutate(prefer.treat.yn = case_when(
    sdoppr == 1              ~ "Yes",
    sdoppr == 2              ~ "Yes",
    sdoppr == 3              ~ "Yes",
    sdoppr == 4              ~ "Yes",
    sdoppr == 5              ~ "Yes",
    sdoppr == 6              ~ "Yes",
    sdoppr == 7              ~ "No",
    sdoppr == 8              ~ "No",
    sdoppr == 9              ~ "No"))

```

Collapse the recoded variables into simplified groups
```{r}
ethos <- ethos %>% 
  mutate(oat.prefer.group = case_when(
    sdoppr == 1              ~ "Methadone",
    sdoppr == 2|sdoppr == 5  ~ "Buprenorphine (oral)",
    sdoppr == 3              ~ "Buprenorphine (oral - any formulation)",
    sdoppr == 4              ~ "Buprenorphine (LAIB)",
    sdoppr == 6              ~ "Any",
    sdoppr == 7              ~ "None",
    sdoppr == 8              ~ "None",
    sdoppr == 9              ~ "None"))
```

PREFERRING ONLY METHADONE OR BUPRENORPHINE

```{r}
ethos <- ethos %>% 
  mutate(prefer.metbup = case_when(
    sdoppr == 1              ~ "Methadone",
    sdoppr == 2|sdoppr == 5  ~ "Buprenorphine",
    sdoppr == 3              ~ "Buprenorphine",
    sdoppr == 4              ~ "Buprenorphine", 
    is.na(TRUE)  ~ NA_character_,
    FALSE                  ~ "NA"))
```  

View the results in a table

```{r}
table(ethos$prefer.metbup)
```


```{r}
tabyl(ethos$prefer.metbup)
```
Drop unused levels of a factor variable

```{r echo = FALSE, include=FALSE} 
fct_drop(ethos$prefer.metbup)
```

Make methadone the reference level [do this by ```fct_relevel()```]. To make methadone the reference level, we need to relevel buprenorphine to the [1] position so that we are looking at the odds of chosing methadone compared to buprenorphine. 

```{r}
ethos <- ethos %>%
  mutate(prefer.metbup = fct_relevel(prefer.metbup,"Buprenorphine", "Methadone"))
```


56. Have you ever been on OAT? 

```{r}
ethos <- ethos %>% 
  mutate(oat.ever.yn = case_when(
    sdost_ever  == 0              ~ "No",
    sdost_ever == 1              ~ "Yes"
  ))
```

57. Have you been on OAT in the last month? 

```{r}
ethos <- ethos %>% 
  mutate(oat.month.yn = case_when(
    sdost_mon  == 0              ~ "No",
    sdost_mon == 1              ~ "Yes"
  ))
```

58. Have you been on OAT in the last 6 months? 
```{r}


ethos <- ethos %>% 
  mutate(oat.6month.yn = case_when(
    sdost_6mon  == 0              ~ "No",
    sdost_6mon == 1              ~ "Yes"
  ))
```

59. Have you been on OAT in the last year? 

```{r}
ethos <- ethos %>% 
  mutate(oat.year.yn = case_when(
    sdost_1yr  == 0              ~ "No",
    sdost_1yr == 1              ~ "Yes"
  ))
```

60. Are you currently receiving OAT? 

```{r}
ethos <- ethos %>% 
  mutate(oat.type = case_when(
    sdost_curr == 1       ~ "Methadone",
    sdost_curr == 2       ~ "Buprenorphine (Subutex)",
    sdost_curr == 3       ~ "Buprenorphine (Any formulation)",
    sdost_curr == 4       ~ "Buprenorphine (long acting injectable)",
    sdost_curr == 5       ~ "Buprenorphine-naloxone (Suboxone)",
    sdost_curr == 77      ~ "Other",
    sdost_curr == 99      ~ "Unknown"
    ))
```

Do you know your current methadone dose? 
```{r}
ethos <- ethos %>% 
  mutate(methadonedose.yn = case_when(
    sdknddoes  == 0              ~ "No",
    sdknddoes == 1              ~ "Yes"
  ))
```

61. What is your current daily dose of methadone (mg)

```{r}
methadone.dose <- as.numeric(ethos$sdmetd)

ethos <- ethos %>% 
  mutate(methadone.dose = as.numeric(methadone.dose))
```


Do you know your current buprenorphine  dose? 
```{r}
ethos <- ethos %>% 
  mutate(methadonedose.yn = case_when(
    sdknddoes  == 0              ~ "No",
    sdknddoes == 1              ~ "Yes"
  ))

```

62. What is your current daily dose of buprenorphine (mg)?

```{r}
methadone.dose <- as.numeric(ethos$sdmetd)

ethos <- ethos %>% 
  mutate(methadone.dose = as.numeric(methadone.dose))
```

63. How often do you receive your dose of long-acting injectable buprenorphine? 

```{r}
ethos <- ethos %>% 
  mutate(bupe.laib = case_when(
    sdodlbp  == 1              ~ "Weekly",
    sdodlbp == 2              ~ "Monthly"
  ))
```

64. What is your current dose of weekly long-acting injectable buprenorphine?

```{r}
laib.dose.wk <- as.numeric(ethos$sdwbud)

ethos <- ethos %>% 
  mutate(laib.dose.wk = as.numeric(laib.dose.wk))

```
64. Do you know your current dose of weekly long-acting injectable buprenorphine?

```{r}
ethos <- ethos %>% 
  mutate(laib.wk.yn = case_when(
    sdwbup  == 0              ~ "No",
    sdwbup == 1              ~ "Yezs"
  ))
```

65. Do you know your current dose of monthly long-acting injectable buprenorphine?

```{r}
ethos <- ethos %>% 
  mutate(laib.month.yn = case_when(
    sdmbuk  == 0              ~ "No",
    sdmbuk == 1              ~ "Yes"
  ))
```

65. What is your current dose of monthly long-acting injectable buprenorphine?

```{r}
laib.dose.month <- as.numeric(ethos$sdmbud)

ethos <- ethos %>% 
  mutate(laib.dose.month = as.numeric(laib.dose.month))
```


66. Are you satisfied with your dose? 

```{r}
ethos <- ethos %>% 
  mutate(dose.satisfied = case_when(
    sddses  == 1              ~ "Yes",
    sddses  == 2              ~ "No, too low",
    sddses  == 3              ~ "No, too high"
  ))
```

67. Where was your last dose dispensed? 

```{r}
ethos <- ethos %>% 
  mutate(dose.location = case_when(
    sddsdis == 1 ~ "Public",
    sddsdis == 2 ~ "Private",
    sddsdis == 3 ~ "Doctor",
    sddsdis == 4 ~ "Pharmacy",
    sddsdis == 5 ~ "Prison", 
    sddsdis == 77 ~ "Other"))
```

68. Do you receive take-away doses? 

```{r}
ethos <- ethos %>% 
  mutate(dose.takeaways.yn = case_when(
    sdtake  == 0              ~ "No",
    sdtake == 1              ~ "Yes"
  ))
```

69. In the last month, how many times per week did you collect your dose? 

```{r}
collection.week <- as.numeric(ethos$sdlmdse)

ethos <- ethos %>% 
  mutate(collection.week = as.numeric(collection.week))
```

109. Please indicate which statement best describes your own health today? 

```{r}
ethos <- ethos %>% 
  mutate(health.pain = case_when(
    sghcpd == 0 ~ "I have no pain or discomfort",
    sghcpd == 1 ~ "I have slight pain or discomfort",
    sghcpd == 2 ~ "I have moderate pain or discomfort",
    sghcpd == 3 ~ "I have severe pain or discomfort",
    sghcpd == 4 ~ "I have extreme pain or discomfort" 
    ))
```

## SECTION D: STIGMA AND DISCRIMINATION

103. In the last 12 months, have you experienced any stigma or discrimination in relation to your use of drugs for injecting?

```{r}
ethos <- ethos %>% 
  mutate(stigma.inject = case_when(
    ggstig == 0 ~ "Never",
    ggstig == 1 ~ "Rarely",
    ggstig == 2 ~ "Sometimes",
    ggstig == 3 ~ "Often",
    ggstig== 4 ~ "Always" 
  ))
```
 a
Create a new yes/no variable that represents if someone has been stigmatised in relation to injecting drug use

```{r}
ethos <- ethos %>% 
  mutate(stigma.inject.yn = case_when(
    ggstig == 0 ~ "No",
    ggstig == 1 ~ "Yes",
    ggstig == 2 ~ "Yes",
    ggstig == 3 ~ "Yes",
    ggstig== 4 ~ "Yes" 
  ))
```

104. In the last 12 months, have you experienced any stigma or discrimination in relation to your hepatitis C status?

```{r}
ethos <- ethos %>% 
  mutate(stigma.hcv  = case_when(
    ggstighc == 0 ~ "Never",
    ggstighc == 1 ~ "Rarely",
    ggstighc == 2 ~ "Sometimes",
    ggstighc == 3 ~ "Often",
    ggstighc == 4 ~ "Always" 
  ))
```

Create a new yes/no variable that represents if someone has been stigmatised in relation to hcv

```{r}

ethos <- ethos %>% 
  mutate(stigma.hcv.yn  = case_when(
    ggstighc == 0 ~ "No",
    ggstighc == 1 ~ "Yes",
    ggstighc == 2 ~ "Yes",
    ggstighc == 3 ~ "Yes",
    ggstighc == 4 ~ "Yes" 
  ))
```

105. In the last 12 months, to what extent do you agree that health workers treated you negatively or different to other people? 

```{r}
ethos <- ethos %>% 
  mutate(discrim = case_when(
    ggstigw == 0 ~ "Never",
    ggstigw == 1 ~ "Rarely",
    ggstigw == 2 ~ "Sometimes",
    ggstigw == 3 ~ "Often",
    ggstigw == 4 ~ "Always" 
  ))
```

Create a new yes/no variable that represents if someone has been discriminated against by health workers

```{r}
ethos <- ethos %>% 
  mutate(discrim.yn = case_when(
    ggstigw == 0 ~ "No",
    ggstigw == 1 ~ "Yes",
    ggstigw == 2 ~ "Yes",
    ggstigw == 3 ~ "Yes",
    ggstigw == 4 ~ "Yes"
  ))
```

## Theme

```{r}
apa_theme <- function (ft)  {
  ft %>%
    flextable::font(fontname = "Times New Roman", part = "all") %>% 
    flextable::fontsize(size = 10, part = "all") %>% 
    flextable::align(align = "left", part = "all") %>% 
    flextable::align(align = "left", part = "header") %>% 
    #flextable::rotate(rotation = "lrtb", align = "top", part = "body") %>% 
    flextable::border_remove() %>% 
    flextable::hline_top(border = officer::fp_border(width = 1.5), part = "all") %>% 
    flextable::hline_bottom(border = officer::fp_border(width = 1.5), part = "header") %>% 
    flextable::autofit()
}
```

```{r, warrnings = FALSE, echo = FALSE}
set_gtsummary_theme(theme_gtsummary_compact())
```


### SUMMARY TABLE OF ALL PARTICIPANT DEMOGRAPHIC AND BEHAVIORAL CHARACTERISTICS STRATIFIED BY WAVE

#### Wave 1 (May 2018- September 2019)
#### Wave 2 (November 2019-June 2021)

```{r}
tbl.pts <-  
  ethos %>%
  filter(waves =="Wave 2") %>%
  tbl_summary(include = c(age, age.group, homeless.fct,
                                           prison.yn, inject.month,
                                           inject.year, injectdrug.month,
                                           injectfreq.month, injectdays.month, 
                                            oat.ever.yn,  
                                            oat.type,
                                            methadone.dose,
                                            laib.dose.wk, 
                                            laib.dose.month,
                                            dose.satisfied, 
                                            dose.location, 
                                            dose.takeaways.yn,
                                            stigma.inject.yn, discrim.yn
                                           ),
                           label = list(age ~ "Age",
                             age.group ~ "Age group", 
                           
                           homeless.fct ~ "Homeless", 
                           prison.yn ~ "Ever incarcerated",
                           inject.month ~ "Recent injecting", 
                           injectdrug.month ~ "Drug recerntly injected", 
                           injectdays.month ~ "No. days injected in the last month",
                            oat.ever.yn ~ "Ever received OAT",
                            oat.type ~ "Type of OAT medication prescribed", 
                            methadone.dose ~ "Current dose of methadone", 
                            laib.dose.wk ~ "Weekly dose of LAIB", 
                            laib.dose.month ~ "Monthly dose of LAIB", 
                            dose.satisfied ~ "Satisfied with current dose", 
                            dose.location ~ "Dose collection site", 
                            dose.takeaways.yn ~ "Receive take-home doses", 
                            stigma.inject.yn ~ "Experience injecting-related stigma", 
                            discrim.yn ~ "Discriminated against"
                          ),missing = "no",
              statistic = all_continuous() ~ ("{median} ({p25} - {p75})")) %>%
  add_stat_label()%>%
  modify_footnote(update = everything() ~ NA, abbreviation = FALSE) %>%
  modify_header(
    label = "**Characteristic** \n (n = {N})")
    # stat_1 = "**Wave 1** \n  (n = {n})",
    # stat_2 = "**Wave 2** \n  (n = {n})") 
```

Convert the table to a flextable

```{r}
tbl.pts.ft <- tbl.pts %>%
  as_flex_table()%>%
  apa_theme()
```

Display the table

```{r}
tbl.pts.ft
```



# UNADJUSTED LOGISTIC REGRESSION 
## ALL PARTICIPANTS

Description: 
- Checking all and the variables with p value >0.2 will go into the final model. Method of model building usually doesn't matter with a large sample. For this analysis the sample size was ~100,000 individuals. For smaller samples that are more sensitive to slight variations it may make a difference. In this case backwards step-wise regression gives a bit more control to the model builder

It's a common mistake people do since most the time their outcome variable is a vector of 0 and 1, and people want to predict 1.# But when such a vector is considered as a factor variable, the reference level is 0 (see below) so that people effectively predict 1. Likewise, your reference level must be "NO" so that you will predict "YES".
    

Description: 
- For this unadjusted logistic regression including all participants [those on OAT and those not], I've removed the variables relating to OAT only participants. For example, clinic attendance, dose location and treatment cost apply to those only currently receiving OAT. 
- It is important to note that for the unadjusted logistic regression, all variables are included, even if they are colinear. For the final model, all colinear variables should be removed.

First we need to subset the dataset so that we only have participants who prefer methadone or buprenorphine. 

```{r}
prefer.only <- ethos %>%
   filter(prefer.metbup == "Methadone" | prefer.metbup == "Buprenorphine")
```

Remove scientific notation 

```{r}
options(scipen = 999)
```

Generate the unadjusted odds ratios and plot the results. 

Change the reference level of the prefer variable so that Buprenorphine is the reference level [instead of methadone as was ordered in the summary tables above so that the Methadone column appears first in the table output]

```{r}
prefer.only <- prefer.only %>% 
  mutate(prefer.metbup = fct_relevel(prefer.metbup,
                                  "Buprenorphine", 
                                  "Methadone"
                                 ))
```

```{r}
prefer.only<- prefer.only %>%
mutate(as.numeric(prefer.only$age))
```


## ODDS RATIOS ALL PARTICIPANTS

```{r}
all.or <-
  prefer.only %>%
  dplyr::select(age, age.group, homeless.fct,
                     prison.yn, inject.month,
                     inject.year, injectdrug.month,
                     injectfreq.month, injectdays.month, 
                     oat.ever.yn,  
                     oat.type,
                     methadone.dose,
                     laib.dose.wk, 
                     laib.dose.month,
                     dose.satisfied, 
                     dose.location, 
                     dose.takeaways.yn,
                     stigma.inject.yn, 
                     discrim.yn, prefer.metbup) %>%
  tbl_uvregression(
    method = glm,
    y = prefer.metbup, 
    label = list(age ~ "Age",
                             age.group ~ "Age group", 
                           
                           homeless.fct ~ "Homeless", 
                           prison.yn ~ "Ever incarcerated",
                           inject.month ~ "Recent injecting", 
                           injectdrug.month ~ "Drug recerntly injected", 
                           injectdays.month ~ "No. days injected in the last month",
                            oat.ever.yn ~ "Ever received OAT",
                            oat.type ~ "Type of OAT medication prescribed", 
                            methadone.dose ~ "Current dose of methadone", 
                            laib.dose.wk ~ "Weekly dose of LAIB", 
                            laib.dose.month ~ "Monthly dose of LAIB", 
                            dose.satisfied ~ "Satisfied with current dose", 
                            dose.location ~ "Dose collection site", 
                            dose.takeaways.yn ~ "Receive take-home doses", 
                            stigma.inject.yn ~ "Experience injecting-related stigma", 
                            discrim.yn ~ "Discriminated against"),
    method.args = list(family = binomial),
    exponentiate = TRUE,
    hide_n = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2)
  ) %>%
  modify_header(
    label = '**Variable**',
    estimate = '**cOR**',
    ci = '**95% CI**',
    p.value = '**p-value**'
  ) %>%
  modify_footnote(update = everything() ~ NA, abbreviation = TRUE) %>%
  modify_table_styling(
    column = estimate,
    rows = !is.na(estimate),
    cols_merge_pattern = "{estimate} ({conf.low} - {conf.high})"
  ) %>%
  modify_header(estimate ~ "**cOR (95% CI)**") %>%
  modify_header(label ~ "**Variable (n = 317)**") %>%
  modify_column_hide(c(ci, p.value)) %>% 
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  #bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  bold_labels()
```

```{r}
all.or
```


Convert to a flextable

```{r}
all.or.ft <- all.or %>%  
as_flex_table()%>%
apa_theme()
```

Display the results

```{r}
all.or.ft 
```


## ODDS RATIOS SELECT PARTICIPANTS

```{r}
subset.or <-
  prefer.only %>%
  dplyr::select(age, gender.mf, income.yn,
         accom.yn, prison.yn, chronicpain.yn, heroin.month, 
          nonmethadone.month,
         nonsuboxone.month, otheropi.month, cocaine.month, meth.month, benzo.month, oat.yn,
         oatever.yn, methadoneever.yn, 
         bupeever.yn, prefer.mb) %>%
  tbl_uvregression(
    method = glm,
    y = prefer.mb, 
    label = list(age ~ "Age",
                 gender.mf ~ "Gender",
                 prison.yn ~ "Ever incarcerated", 
                 accom.yn ~ "Currently in stable housing",
                 income.yn ~ "Currently employed",
                 chronicpain.yn ~ "Chronic pain",
                 heroin.month ~ "Heroin use",
                 nonmethadone.month ~ "Non-prescribed methadone use", 
                 nonsuboxone.month ~ "Non-prescribed suboxone use",
                 
                 otheropi.month ~ "Non-prescribed pharmaceutical opioid use", 
                 cocaine.month ~ "Cocaine use", 
                 meth.month ~ "Methamphetamine use", 
                 benzo.month ~ "Benzodiazepine use",
                 oat.yn ~ "Currently receiving OAT",
                 oatever.yn ~ "Ever received OAT", 
                 methadoneever.yn ~ "Ever received OAT with methadone", 
                 bupeever.yn ~ "Ever received OAT with buprenorphine"),
    method.args = list(family = binomial),
    exponentiate = TRUE,
    hide_n = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2)
  ) %>%
  modify_header(
    label = '**Variable**',
    estimate = '**cOR**',
    ci = '**95% CI**',
    p.value = '**p-value**'
  ) %>%
  modify_footnote(update = everything() ~ NA, abbreviation = TRUE) %>%
  modify_table_styling(
    column = estimate,
    rows = !is.na(estimate),
    cols_merge_pattern = "{estimate} ({conf.low} - {conf.high})"
  ) %>%
  modify_header(estimate ~ "**cOR (95% CI)**") %>%
  modify_header(label ~ "**Variable (n = 317)**") %>%
  modify_column_hide(c(ci, p.value)) %>% 
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  #bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  bold_labels()
```

Convert to a flextable

```{r}
subset.or.ft <- subset.or %>%  
as_flex_table()%>%
apa_theme()
```

Display the results

```{r}
subset.or.ft 
```






























***

## ETHOS ENGAGE STUDY SITE LOCATIONS

  
```{r}
ethos.loc <- read_csv("ethos.locations.csv")
gt(head(ethos.loc))
```


```{r}

library(ozmaps)
sf_aus <- ozmap("states")
names(sf_aus)

```
 
```{r}
cities 
town <- peerbus %>% 
  arrange(Town) %>% 
  group_by(Town) %>% 
  filter(row_number()==1) %>% 
  ungroup()
```

```{r} 
ggplot() + 
geom_sf(data = sf_aus) +
  # geom_sf() +
  # geom_point(aes(x = Longitude, y = Latitude)) +
  xlim(112, 155) +
  ylim(45, 10) +
  labs() +
  theme_bw() +
    theme_minimal()
```

  
```{r}  
 m1 <- ggplot() + 
  geom_sf(data = sf_aus) +
  # geom_point(aes(x = Longitude, y = Latitude, colour = Location), alpha = 0.75) +
  xlim(112, 155) +
  # geom_rect(aes(xmin = 147, xmax = 154, ymin = -36, ymax = -30), color = "red", fill = NA) +
    labs( x="",
          y="")+`
  theme_bw()+
    theme_test() +
    theme(panel.background =
    element_rect(fill = "lightblue")) +
    guides(size = "none") 

m1
```

#### Loading the required packages
```{r}
require(sf)
require(ggplot2)
require(cowplot)
require(tmap)
```

```{r}
shape1 <- read_sf(dsn = "C:/Users/mjstowe/OneDrive - UNSW/Desktop/R", layer = "STE11aAust")

ggplot(shape1)

```


```{r}



map1 <- ggplot() + 
  geom_sf(data = shape1)

map1
```

Reading in the shape file with the boundaires of the Primary Health Networks

```{r}
shape <- read_sf(dsn = "C:/Users/mjstowe/OneDrive - UNSW/Desktop/R", layer = "Primary_Health_Networks")
```

Reading in the .csv file that contains all the gps coordinateslatitude and longitude 

```{r}
ethos.loc <- read.csv("ethos.locations.csv")
```


#### Australia
Creating a map of Australia that shows all the states and territories. 

```{r}

map <- ggplot() + 
  geom_sf(data = shape) +
   xlim(105, 160) +
  geom_rect(aes(xmin = 148, xmax = 154, ymin = -36, ymax = -26), color = "red", fill =   NA) +
  labs() +
labs( x="",
      y="") +
  theme_test() +
  theme(panel.background = element_rect(fill = "lightblue")) +
    geom_point(aes(x = Longitude,
                 y = Latitude, fill = "red"), shape= 21, colour="black", data = ethos.loc, size=2, show.legend = FALSE) 
```

```{r}
map
```
#### New South Wales

creating a map of New South Wales

Filtering the states so that only NSW is selected. 
```{r}
nsw.map <- shape %>%
  filter(STATE == "New South Wales")
```

Filtering the site locations [gps coordinates] so that only the sites in NSW are selected. 
```{r}
nsw.loc <- ethos.loc %>%
  filter(State == "NSW")
```

Creating a map of NSW with the site location labels. 
```{r}

 par(
    mar = c(1, 1, 1, 1)
  )  
  map.nsw <- ggplot() + 
  geom_sf(data = nsw.map) +
   xlim(141, 155) +
  ylim(-38, -26) +
        geom_rect(aes(xmin = 148, xmax = 154, ymin = -36, ymax = -28), color = "red", fill = NA) +
   # labs(subtitle="New South Wales"
   #     ) +
  theme_bw() +
labs( x="",
      y="") +
      geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = nsw.loc, show.legend = FALSE) +
     ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = nsw.loc, nudge_y = 0.06, nudge_x = 0.06, size = 2.5, 
                              max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +

theme_void() +
      theme(
    # legend.justification defines the edge of the legend that the legend.position coordinates refer to
    legend.justification = c(0, 1),
    # Set the legend flush with the left side of the plot, and just slightly below the top of the plot
    legend.position = c(0, .95)
    )+
      # Prevent ggplot from slightly expanding the map limits beyond the bounding box of the spatial objects
  coord_sf(expand = FALSE) +
  theme_void() +
  theme(
    legend.justification = c(0, 1),
    legend.position = c(0, .95)
    ) +
  theme(
    text = element_text(family = "Futura-Medium"),
    legend.title = element_text(family = "Futura-Bold", size = 10),
    legend.text = element_text(family = "Futura-Medium", size = 10)
    ) 
  # geom_point(aes(x = Longitude,
  #                y = Latitude, fill = Site, colour="red"),shape = 21, colour= "black", stroke = 0.5, data = nsw.loc, size=2, show.legend = TRUE)+
  # geom_rect(aes(xmin = 150, xmax = 151.5, ymin = -35.5, ymax = -33), color = "red", fill = NA) + 

map.nsw
  
```


Creating a map of NSW without the labels. These maps will be used for creating inset maps. 
```{r}

 par(
    mar = c(1, 1, 1, 1)

  )  
  map.nsw1 <- ggplot() + 
  geom_sf(data = nsw.map) +
    xlim(141, 155) +
  ylim(-38, -26) +
  geom_rect(aes(xmin = 148, xmax = 154, ymin = -36, ymax = -28), color = "red", fill =   NA) +
   # labs(subtitle="New South Wales"
   #     ) +
  theme_bw() +
labs( x="",
      y="") +
      geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = nsw.loc, show.legend = FALSE) +
     # ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = nsw.loc, nudge_y = 0.06, nudge_x = 0.06, size = 2) +

theme_void() +
      theme(
    # legend.justification defines the edge of the legend that the legend.position coordinates refer to
    legend.justification = c(0, 1),
    # Set the legend flush with the left side of the plot, and just slightly below the top of the plot
    legend.position = c(0, .95)
    )+
      # Prevent ggplot from slightly expanding the map limits beyond the bounding box of the spatial objects
  coord_sf(expand = FALSE) +
  theme_void() +
  theme(
    legend.justification = c(0, 1),
    legend.position = c(0, .95)
    ) +
  theme(
    text = element_text(family = "Futura-Medium"),
    legend.title = element_text(family = "Futura-Bold", size = 10),
    legend.text = element_text(family = "Futura-Medium", size = 10)
    ) 
  # geom_point(aes(x = Longitude,
  #                y = Latitude, fill = Site, colour="red"),shape = 21, colour= "black", stroke = 0.5, data = nsw.loc, size=2, show.legend = TRUE)+
  # geom_rect(aes(xmin = 150, xmax = 151.5, ymin = -35.5, ymax = -33), color = "red", fill = NA) + 
```

Display the map of NSW without the site labels

```{r}
map.nsw1
```
Creating the inset map.
```{r}
mapA <- map.nsw +
coord_sf(
    xlim = c(148, 154),
    ylim = c(-28, -35.5),
    expand = FALSE
    )
```

Draw the inset map
```{r}
ggdraw(map.nsw1) +
  draw_plot(
    {
      map.nsw + 
        coord_sf(
          xlim = c(148, 154),
          ylim = c(-28, -35.5),
          expand = FALSE) +
        theme(legend.position = "none")
      },
    # The distance along a (0,1) x-axis to draw the left edge of the plot
    x = 0.1, 
    # The distance along a (0,1) y-axis to draw the bottom edge of the plot
    y = 0.1,
    # The width and height of the plot expressed as proportion of the entire ggdraw object
    width = 0.9, 
    height = 0.9)
```


```{r}
 cowplot::plot_grid(map.nsw1, mapA, nrow = 1, labels = "AUTO", align = "v")
```




inset

```{r}
inset <- covid_cases_nsw %>% 
  ggplot() + 
  geom_sf() +
  ggplot(aes(location = lga)) +
  geom_boundaries(feature_type = "nswgeo.lga") +
  # geom_rect(aes(xmin = 150, xmax = 152, ymin = -35.5, ymax = -33), color = "red", fill = NA) +
  xlim(150, 152.6) +
  ylim(-34.3, -33) +
  labs(x = NULL, y = NULL) +
  geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = nsw.loc, show.legend = FALSE) +
    geom_centroids(aes(colour = type), position = position_circle_repel_sf(scale = 35), size = 1) +
  geom_inset_frame() +
    coord_automap(feature_type = "nswgeo.lhd", inset = configure_inset(
    centre = "Sydney", radius = 80, units = "km", feature_type = "nswgeo.lhd",
    scale = 6, translation = c(650, -100)
  )) +
     # ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = nsw.loc, nudge_y = 0.06, nudge_x = 0.06, size = 2) +
  theme_test() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.ticks.length = unit(0, "pt"),
        axis.title=element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.background = element_rect(fill = "lightblue"))
```

```{r}
inset
```


South Australia



```{r}
sa.map <- shape %>%
  filter(STATE == "South Australia")
```

```{r}
sa.loc <- ethos.loc %>%
  filter(State == "SA")
```

```{r}
 par(
    mar = c(1, 1, 1, 1),
    mgp = c(0, 0, 0)
  ) 
```


```{r}
   
  map.sa <- ggplot() + 
  geom_sf(data = sa.map) +
   # xlim(130, 140) +
    ylim(-38, -26) +
  # labs(subtitle="Victoria"
  #      ) +
  theme_bw() +
labs( x="",
      y="") +
      geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = sa.loc, show.legend = FALSE) +
    ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = sa.loc, nudge_y = 0.06, nudge_x = 0.06, size = 3, 
                              max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
  theme_void()
  #    theme_test() + 
  # theme(axis.text = element_blank(),
  #       axis.ticks = element_blank(),
  #       axis.ticks.length = unit(0, "pt"),
  #       axis.title=element_blank(),
  #       plot.margin = margin(0, 0, 0, 0, "cm"),
  #       panel.background = element_rect(fill = "lightblue")) +
  #      theme_test() 
```


```{r}
map.sa
```
Queensland



```{r}
qld.map <- shape %>%
  filter(STATE == "Queensland")
```

```{r}
qld.loc <- ethos.loc %>%
  filter(State == "QLD")
```

```{r}
 par(
    mar = c(0, 0, 0, 0),
    mgp = c(0, 0, 0)
  )
```


```{r}
map.qld <- ggplot() + 
  geom_sf(data = qld.map) +
  
   # xlim(130, 140) +
    # ylim(-38, -26) +
  # labs(subtitle="Victoria"
  #      ) +
  theme_bw() +
labs( x="",
      y="") +
      geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = qld.loc, show.legend = FALSE) +
  ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = qld.loc, nudge_y = 0.06, nudge_x = 0.06, size = 3, 
                              max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
  theme_void()
  #    theme_test() + 
  # theme(axis.text = element_blank(),
  #       axis.ticks = element_blank(),
  #       axis.ticks.length = unit(0, "pt"),
  #       axis.title=element_blank(),
  #       plot.margin = margin(0, 0, 0, 0, "cm"),
  #       panel.background = element_rect(fill = "lightblue")) +
  #      theme_test() 
```


```{r}

map.qld

```

Combining the South Australia and Queensland maps

```{r}
cowplot::plot_grid(map.sa, map.qld, nrow = 1, labels = c("C", "D"), align = "v")
```

Western Australia


```{r}
wa.map <- shape %>%
  filter(STATE == "Western Australia")
```

```{r}
wa.loc <- ethos.loc %>%
  filter(State == "WA")
```

```{r}
 par(
    mar = c(0, 0, 0, 0),
    mgp = c(0, 0, 0)
  )
```


```{r}
map.wa <- ggplot() + 
  geom_sf(data = wa.map) +
  
   # xlim(130, 140) +
    # ylim(-38, -26) +
  # labs(subtitle="Victoria"
  #      ) +
  theme_bw() +
labs( x="",
      y="") +
      geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", fill = "red", data = wa.loc, show.legend = FALSE) +
  ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site ), data = wa.loc, nudge_y = 0.06, nudge_x = 0.06, size = 3, 
                              max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
  theme_void()
  #    theme_test() + 
  # theme(axis.text = element_blank(),
  #       axis.ticks = element_blank(),
  #       axis.ticks.length = unit(0, "pt"),
  #       axis.title=element_blank(),
  #       plot.margin = margin(0, 0, 0, 0, "cm"),
  #       panel.background = element_rect(fill = "lightblue")) +
  #      theme_test() 
```


```{r}

map.wa

```

Combining the South Australia and Queensland maps

```{r}
cowplot::plot_grid(map.sa, map.qld, map.wa, nrow = 1, labels = c("C", "D", "E"), align = "v")
```






```{r}
  map_state <- ggplot() + 
  geom_sf(data = map_nsw) +
  labs() +
  theme_bw() +
labs( x="",
      y="") +
  theme_test()+
  theme(panel.background = element_rect(fill = "lightblue")) +
    geom_point(aes(x = Longitude,
                 y = Latitude, fill = "Site"), shape= 21, colour="black", data = ethos.loc, size=3, show.legend = FALSE)+
  theme_void() + 
  labs(title ="Map of Australia") +
  labs(subtitle ="Showing states") +
  theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 1))+ 
  facet_wrap( ~ STATE)
```


```{r}
map_states <- shape %>%
  filter(STATE == "New South Wales" | STATE == "Queensland" |
         STATE == "Victoria")
```

```{r}
ss <- shape %>% 
  # filter(STATE == "New South Wales") %>%
  ggplot() + 
  geom_sf() +
  geom_point(aes(x = Longitude, y = Latitude, fill = State, shape = State), alpha = 0.75, data = ethos.loc) +
  scale_size_manual(values=c(2,3.5)) +
  # xlim(147, 153) +
  # ylim(-38, -30) +
  ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Site), data = ethos.loc, nudge_y = 0.06, nudge_x = 0.06, size = 2) +
  labs( x="",
      y="") +
  theme_test() +
  theme(panel.background = element_rect(fill = "lightblue")) +
  guides(size = "none") 
  # ggsn::north(location = "topleft", scale = 0.8, symbol = 12,
  #              x.min = 151.5, x.max = 152.5, y.min = -36, y.max = -38) +
  # ggsn::scalebar(location = "bottomleft", dist = 100,
  #          dist_unit = "km", transform = TRUE, 
  #          x.min=150.5, x.max=152, y.min=-38, y.max=-30,
  #          st.bottom = FALSE, height = 0.025,
  #          st.dist = 0.05, st.size = 3)
```

```{r}
ss
```


```{r}
map_state
```




```{r}
map <- shape %>%
  filter(PHN_Name == "South Sydney") %>%   # let's just look Melbourne
  ggplot() +
  geom_sf(aes(geometry = geometry),  # use the geometry variable
              fill = AREA_sqkm) +
      geom_point(aes(x = Longitude,
                 y = Latitude, fill = "red"), shape= 21, colour="black", data = ethos.loc, size=3, show.legend = FALSE)

```
 



```{r}
map_filter <- shape %>%
  # filter(PHN_Name == "Hunter New England and Central Coast") %>% 
  ggplot() + 
  geom_sf(data = shape) +
  # geom_point(aes(x = 151.2146,
                 # y = -33.8831), alpha = 0.75, shape = 21, colour = "black", fill = "red", size = 2) +
  xlim(147, 154) +
  ylim(-38, -26) +
  labs(x="",
       y="") +
  geom_point(aes(x = Longitude,
                 y = Latitude, fill = Site), shape= 21, colour="black", data = ethos.loc) +
  labs(fill="Sites Visited in Local Health Districts") +
  geom_rect(aes(xmin = 150.5, xmax = 153.5, ymin = -34.5, ymax = -30), color = "red", fill = NA) +
  theme_test() +
  theme(panel.background = element_rect(fill = "lightblue")) +
  guides(size = "none") +
  ggsn::north(location = "topleft", scale = 0.8, symbol = 12,
              x.min = 151.5, x.max = 152.5, y.min = -36, y.max = -38) +
  ggsn::scalebar(location = "bottomleft", dist = 100,
                 dist_unit = "km", transform = TRUE, 
                 x.min=150.5, x.max=152, y.min=-38, y.max=-30,
                 st.bottom = FALSE, height = 0.025,
                 st.dist = 0.05, st.size = 2)

```                 


```{r}
map_filter
```

```{r}

# Filter electorates in the Sydney metropolitan region
lhd_map <- shape %>% filter(PHN_Name %in% c(
  "Hunter New England and Central Coast", "Central and Eastern Sydney", "North Coast", "South Eastern NSW"
))
```

```{r}
# Draw the electoral map of Sydney
ggplot(shape) + 
   xlim(144, 158) +
   ylim(-40, -26) +
coord_sf() +
  geom_sf_label(aes(label = PHN_Name))+
geom_sf(aes(geometry = geometry, fill = PHN_Name), lwd = 0,                  # remove borders
        show.legend = FALSE) +
  # xlim(147, 154) +
  # ylim(-38, -30) +
  labs(x="",
       y="") +                    # clears other plot elements
  theme_minimal() 
  theme(panel.background = element_rect(fill = "lightblue")) +
  guides(size = "none") +
  ggsn::north(location = "topleft", scale = 0.8, symbol = 12,
              x.min = 151.5, x.max = 152.5, y.min = -36, y.max = -38) +
  ggsn::scalebar(location = "bottomleft", dist = 100,
                 dist_unit = "km", transform = TRUE, 
                 x.min=150.5, x.max=152, y.min=-38, y.max=-30,
                 st.bottom = FALSE, height = 0.025,
                 st.dist = 0.05, st.size = 2.5)

```

```{r}
ggplot(shape) +
  geom_sf(data=shape)+
  geom_sf_label(aes(label = PHN_Name))+
  geom_sf(aes(geometry = geometry, fill = PHN_Name), lwd = 0,                  # remove borders
        show.legend = FALSE, data=shape) +

  labs(x="",
       y="") +                    # clears other plot elements
  theme_minimal() 
  theme(panel.background = element_rect(fill = "lightblue")) 
```






```{r}
ethos.loc <- read.csv("ethos.locations.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), remove = FALSE)
```


```{r}

mapview(shape, alpha.regions = 0, colour = "red", lwd = 2, layer.name = "Primary Health Networks, Australia") + 
mapview(ethos.loc, zcol="rna_prev", layer.name = "HCV RNA prevalence (%)") + 
mapview(ethos.loc, zcol="recruitment", layer.name = "No. of participants recruited")

```









#  Plotting only Hunter New England

map_HNE <- shape %>%
  filter(PHN_Name == "Hunter New England and Central Coast")

HNE <- peerbus %>%
  filter(LHD == "Hunter New England")

HNE_map <-  ggplot() +
  geom_sf(data=map_HNE)+
     # xlim(147, 156) +
     # ylim(-38, -26) +
    labs(x="",
         y="") +
    geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", data = HNE, show.legend = FALSE) +
    ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Location), data = HNE, nudge_y = 0.06, nudge_x = 0.06, size = 2) +
    labs(fill="Sites Visited in Local Health Districts") + 
    theme_test()# clears other plot elements
  
  
  
  #  Plotting only North Coast
  
  map_NC <- shape %>%
    filter(PHN_Name == "North Coast")
  
  NC <- peerbus %>%
    filter(LHD == "Mid-North Coast")
  
 NC_map <-  ggplot() +
    geom_sf(data=map_NC)+
    # xlim(149, 154) +
    # ylim(-38, -26) +
    labs(x="",
         y="") +
    geom_point(aes(x = Longitude,
                   y = Latitude), shape= 21, colour="black", data = NC, show.legend = FALSE) +
    ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Location), data = NC, nudge_y = 0.06, nudge_x = 0.06, size = 2) +
    labs(fill="Sites Visited in Local Health Districts") + 
    theme_test()# clears other plot elements
  

 
 #  Plotting only Central and Eastern Sydney
 
 map_CES <- shape %>%
   filter(PHN_Name == "Central and Eastern Sydney")
 
 CES <- peerbus %>%
   filter(LHD == "South East Sydney")
 
 CES_map <-  ggplot() +
   geom_sf(data=map_CES)+
   xlim(150.8, 151.4) +
   ylim(-34.5, -33.5) +
   labs(x="",
        y="") +
   geom_point(aes(x = Longitude,
                  y = Latitude), shape= 21, colour="black", data = CES, show.legend = FALSE) +
   ggrepel::geom_text_repel(aes(x = Longitude, y = Latitude, label = Location), data = CES, nudge_y = 0.06, nudge_x = 0.06, size = 2) +
   labs(fill="Sites Visited in Local Health Districts") + 
   theme_test()# clears other plot element

 CES_map  
  
# Plotting all three maps
  

  cowplot::plot_grid(HNE_map, NC_map, CES_map, nrow = 1, labels = c("A", "B", "C"))

  guides(size = "none") +
  ggsn::north(location = "topleft", scale = 0.8, symbol = 12,
              x.min = 151.5, x.max = 152.5, y.min = -36, y.max = -38) +
  ggsn::scalebar(location = "bottomleft", dist = 100,
                 dist_unit = "km", transform = TRUE, 
                 x.min=150.5, x.max=152, y.min=-38, y.max=-30,
                 st.bottom = FALSE, height = 0.025,
                 st.dist = 0.05, st.size = 2.5)







map_filter1


```


